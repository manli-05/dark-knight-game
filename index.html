
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>帝国游戏</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      color: white;
      text-shadow: 1px 1px 3px black;
      background-size: cover;
      background-attachment: fixed;
    }
    .panel {
      padding: 10px;
      background: rgba(0,0,0,0.5);
      max-width: 480px;
    }
    #map button {
      margin: 4px;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>帝国征服</h1>
    <label for="race">选择种族：</label>
    <select id="race" onchange="selectRace()"></select>
    <p id="info"></p>
    <button onclick="useSkill()">使用种族技能</button>
    <div id="map"></div>
  </div>

  <script>
    let race = localStorage.getItem('race') || null;
    let cities = [];
    let conquered = JSON.parse(localStorage.getItem('conquered') || '[]');
    let cooldown = 0;

    const races = {
      human: { name: '人类', bonus: '金币产量+20%', skill: () => addGold(200), base: 0 },
      orc: { name: '兽人', bonus: '军队增长+2', skill: () => addArmy(50), base: 100 },
      elf: { name: '精灵', bonus: '占领奖励翻倍', skill: () => addArmy(3), base: 200 },
      undead: { name: '亡灵', bonus: '失败复活50%', skill: () => { addGold(50); addArmy(30); }, base: 300 },
      dwarf: { name: '矮人', bonus: '城市升级便宜', skill: () => upgradeCity(), base: 400 }
    };

    function generateCities() {
      let cityList = [];
      let raceStart = {
        human: { prefix: '王国', base: 0, bg: 'bg_human.jpg' },
        orc: { prefix: '兽域', base: 100, bg: 'bg_orc.jpg' },
        elf: { prefix: '精灵林', base: 200, bg: 'bg_elf.jpg' },
        undead: { prefix: '亡魂地', base: 300, bg: 'bg_undead.jpg' },
        dwarf: { prefix: '矮人山', base: 400, bg: 'bg_dwarf.jpg' }
      };

      let start = raceStart[race]?.base || 0;
      let prefix = raceStart[race]?.prefix || '敌城';
      let bg = raceStart[race]?.bg || 'default_bg.jpg';

      document.body.style.backgroundImage = `url('images/${bg}')`;

      for (let i = 0; i < 50; i++) {
        cityList.push({
          id: start + i,
          name: `${prefix} ${i + 1}`,
          defense: 20 + Math.floor(Math.random() * 40) + i * 5
        });
      }
      return cityList;
    }

    function selectRace() {
      race = document.getElementById('race').value;
      localStorage.setItem('race', race);
      cities = generateCities();
      localStorage.setItem('cities', JSON.stringify(cities));
      conquered = [];
      currentMapIndex = 0;
      updateUI();
    }

    function unlockRaces() {
      const keys = Object.keys(races);
      if (!race) {
        race = keys[Math.floor(Math.random() * keys.length)];
        localStorage.setItem('race', race);
      }
      cities = generateCities();
      localStorage.setItem('cities', JSON.stringify(cities));

      const sel = document.getElementById('race');
      sel.innerHTML = '';
      keys.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.innerText = `${races[r].name}：${races[r].bonus}`;
        sel.appendChild(opt);
      });
      sel.value = race;
    }

    let currentMapIndex = 0;
    function drawMap() {
      const map = document.getElementById('map');
      map.innerHTML = '';

      const pageSize = 10;
      const pageCities = cities.slice(currentMapIndex * pageSize, (currentMapIndex + 1) * pageSize);

      pageCities.forEach(city => {
        const btn = document.createElement('button');
        btn.className = 'city-btn';
        btn.innerText = city.name + (conquered.includes(city.id) ? ' ✅' : '');
        btn.onclick = () => attack(city);
        map.appendChild(btn);
      });

      const nav = document.createElement('div');
      nav.style.marginTop = '10px';
      if (currentMapIndex > 0) {
        const prev = document.createElement('button');
        prev.innerText = '← 上一页';
        prev.onclick = () => { currentMapIndex--; drawMap(); };
        nav.appendChild(prev);
      }
      if ((currentMapIndex + 1) * pageSize < cities.length) {
        const next = document.createElement('button');
        next.innerText = '下一页 →';
        next.onclick = () => { currentMapIndex++; drawMap(); };
        nav.appendChild(next);
      }
      map.appendChild(nav);
    }

    function updateUI() {
      document.getElementById('info').innerText =
        `当前种族：${races[race].name}｜征服城市数：${conquered.length}｜技能冷却：${cooldown}秒`;
      drawMap();
    }

    function attack(city) {
      if (!conquered.includes(city.id)) {
        conquered.push(city.id);
        localStorage.setItem('conquered', JSON.stringify(conquered));
        alert(`成功征服：${city.name}`);
        updateUI();
      } else {
        alert(`${city.name} 已征服`);
      }
    }

    function useSkill() {
      if (cooldown > 0) {
        alert("技能冷却中");
        return;
      }
      races[race].skill();
      cooldown = 30;
    }

    function addGold(amount) {
      console.log("获得金币：", amount);
    }

    function addArmy(amount) {
      console.log("获得军队：", amount);
    }

    function upgradeCity() {
      console.log("城市升级！");
    }

    function unlockOtherMaps() {
      const all = Object.keys(races);
      const next = all.find(r => r !== race && !conquered.some(id => Math.floor(id / 100) === races[r].base / 100));
      if (next) {
        alert(`你已征服当前地图的大部分，前往新的种族地图：${races[next].name}`);
        race = next;
        localStorage.setItem('race', race);
        cities = generateCities();
        conquered = [];
        currentMapIndex = 0;
        updateUI();
      }
    }

    setInterval(() => {
      if (cooldown > 0) {
        cooldown--;
        updateUI();
      }
      if (conquered.length >= 40) {
        unlockOtherMaps();
      }
    }, 1000);

    window.onload = () => {
      unlockRaces();
      updateUI();
    };
  </script>
</body>
</html>
