<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>帝国游戏 Empire Game</title>
  <style>
    body {
      margin: 0;
      background: black;
      overflow: hidden;
      font-family: 'Press Start 2P', monospace;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background-color: #222;
      image-rendering: pixelated;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<canvas id="gameCanvas" width="1024" height="768"></canvas>
<audio id="upgrade-sfx" src="https://cdn.pixabay.com/download/audio/2022/10/24/audio_7e3ae7d295.mp3" preload="auto"></audio>
<audio id="capture-sfx" src="https://cdn.pixabay.com/download/audio/2021/09/08/audio_96b6ec56c5.mp3" preload="auto"></audio>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const upgradeSFX = document.getElementById("upgrade-sfx");
const captureSFX = document.getElementById("capture-sfx");

let tick = 0;
const cities = [
  { id: 1, name: "王都", x: 200, y: 150, owner: "玩家", level: 1, food: 100, gold: 100 },
  { id: 2, name: "北境", x: 400, y: 120, owner: "AI", level: 1, food: 100, gold: 100 },
  { id: 3, name: "南方", x: 700, y: 500, owner: "AI", level: 1, food: 100, gold: 100 },
  { id: 4, name: "东海", x: 300, y: 600, owner: "AI", level: 1, food: 100, gold: 100 }
];

function drawCities() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (const city of cities) {
    ctx.beginPath();
    ctx.arc(city.x, city.y, 10 + city.level * 2, 0, 2 * Math.PI);
    ctx.fillStyle = city.owner === "玩家" ? "#4caf50" : "#f44336";
    ctx.fill();
    ctx.strokeStyle = "#fff";
    ctx.stroke();
    ctx.font = "10px sans-serif";
    ctx.fillStyle = "white";
    ctx.fillText(`${city.name} ★${city.level}`, city.x - 20, city.y - 15);
    ctx.fillText(`粮:${city.food}`, city.x - 20, city.y + 20);
    ctx.fillText(`金:${city.gold}`, city.x - 20, city.y + 32);
  }
}

function playCaptureAnimation(x, y) {
  let alpha = 1.0;
  captureSFX.play();
  const interval = setInterval(() => {
    ctx.beginPath();
    ctx.arc(x, y, 30, 0, 2 * Math.PI);
    ctx.strokeStyle = `rgba(255, 255, 0, ${alpha})`;
    ctx.lineWidth = 3;
    ctx.stroke();
    alpha -= 0.05;
    if (alpha <= 0) clearInterval(interval);
  }, 50);
}

function getDistance(a, b) {
  return (a.x - b.x) ** 2 + (a.y - b.y) ** 2;
}

function aiAttack() {
  for (const city of cities) {
    if (city.owner === "AI") {
      const targets = cities.filter(c => c.owner === "玩家");
      if (targets.length > 0) {
        targets.sort((a, b) => getDistance(city, a) - getDistance(city, b) || a.level - b.level);
        const target = targets[0];
        target.owner = "AI";
        playCaptureAnimation(target.x, target.y);
        console.log(`AI 占领了 ${target.name}`);
      }
    }
  }
  drawCities();
}

function resourceTick() {
  for (const city of cities) {
    city.food += 10 * city.level;
    city.gold += 5 * city.level;
  }
}

canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  for (const city of cities) {
    const dx = city.x - x;
    const dy = city.y - y;
    if (dx * dx + dy * dy < 400 && city.owner === "玩家") {
      const cost = city.level * 50;
      if (city.food >= cost && city.gold >= cost && city.level < 5) {
        city.level++;
        city.food -= cost;
        city.gold -= cost;
        upgradeSFX.play();
        console.log(`城市 ${city.name} 升级为 ${city.level} 级`);
      }
    }
  }
  drawCities();
});

function gameLoop() {
  tick++;
  if (tick % 300 === 0) aiAttack();
  if (tick % 60 === 0) resourceTick();
  drawCities();
  requestAnimationFrame(gameLoop);
}

drawCities();
gameLoop();
</script>
</body>
</html>
